<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Native Bridge Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 20px;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 16px; /* расстояние между кнопками */
    }
    button:active {
      opacity: 0.7;
    }
    input {
      width: 90%;
      max-width: 400px;
      margin-top: 16px;
      font-size: 16px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h1>Bridge Test</h1>

  <div>
    <button id="sendBtn">Отправить команду в native</button>
  </div>
  <div>
    <button id="sendAnalyticsFull">Analytics full</button>
  </div>
  <div>
    <button id="sendAnalyticsEmpty">Analytics empty</button>
  </div>
  <div>
    <button id="sendAnalyticsNil">Analytics nil</button>
  </div>
  <div>
    <button id="refreshToken">Refresh token</button>
  </div>

  <input type="text" id="output" placeholder="Здесь появятся события от native" readonly />

  <input type="text" id="cookieMcd" placeholder="cookie is-mcd" readonly />
  <input type="text" id="cookieRsid" placeholder="cookie rsid" readonly />

<script>
  // ---- Универсальный JS Bridge ----
  window.NativeBridge = (function () {
    const listeners = {};

    function sendToIOS(message) {
      try {
        if (window.webkit?.messageHandlers?.nativeBridge) {
          // iOS WKWebView accepts a JS object
          window.webkit.messageHandlers.nativeBridge.postMessage(message);
          return true;
        }
      } catch (e) { console.warn(e); }
      return false;
    }

    function sendToAndroid(message) {
      try {
        const json = JSON.stringify(message);
        if (window.NativeBridgeAndroid?.postMessage) {
          window.NativeBridgeAndroid.postMessage(json);
          return true;
        }
        if (window.Android?.postMessage) {
          window.Android.postMessage(json);
          return true;
        }
      } catch (e) { console.warn(e); }
      return false;
    }

    function send(name, payload) {
      const msg = { name, payload };
      if (!sendToIOS(msg) && !sendToAndroid(msg)) {
        console.warn('No native bridge found for message:', msg);
      }
    }

    function receive(name, payload) {
      const list = listeners[name];
      if (list) list.forEach((cb) => {
        try { cb(payload); } catch (e) { console.error(e); }
      });
    }

    function on(name, callback) {
      listeners[name] = listeners[name] || [];
      listeners[name].push(callback);
    }

    /**
     * Сигнатура вызова из native:
     * window.__nativeReceive(name, payloadJSON)
     * Но иногда native может послать один объект { name, payload } — поддерживаем оба варианта.
     */
    window.__nativeReceive = function (arg1, arg2) {
      try {
        if (typeof arg1 === 'string') {
          // стандартный: (name, payloadJSON)
          let payload = arg2;
          if (typeof arg2 === 'string') {
            try { payload = JSON.parse(arg2); } catch {}
          }
          receive(arg1, payload);
        } else if (arg1 && typeof arg1 === 'object' && 'name' in arg1) {
          // вариант: single object { name, payload }
          receive(arg1.name, arg1.payload);
        } else {
          console.warn('__nativeReceive: unknown args', arg1, arg2);
        }
      } catch (e) {
        console.error('Error in __nativeReceive', e);
      }
    };

    return { send, on };
  })();
  // ---- Конец JS Bridge ----

  // DOM элементы
  const output = document.getElementById('output');
  const cookieMcd = document.getElementById('cookieMcd');
  const cookieRsid = document.getElementById('cookieRsid');

  const btnSend = document.getElementById('sendBtn');
  const btnAnalyticsFull = document.getElementById('sendAnalyticsFull');
  const btnAnalyticsEmpty = document.getElementById('sendAnalyticsEmpty');
  const btnAnalyticsNil = document.getElementById('sendAnalyticsNil');
  const btnRefresh = document.getElementById('refreshToken');

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-.+*]/g, '\\$&') + '=([^;]*)'));
    return match ? decodeURIComponent(match[1]) : '';
  }

  cookieMcd.value = getCookie("is-mcd") || "(нет cookie)";
  cookieRsid.value = getCookie("rsid") || "(нет cookie)";

  btnSend?.addEventListener('click', () => {
    const payload = { event_type: "on_personal_account_pressed" };
    NativeBridge.send('on_personal_account_pressed', payload);
    output.value = "Отправлено в native: " + JSON.stringify(payload);
  });

  btnAnalyticsFull?.addEventListener('click', () => {
    const payload = {
      name: "some_test_analytics_name_full",
      params: {
        user_id: "1234",
        some_values: [
          { some_value: "1" },
          { some_value: "2" }
        ]
      }
    };
    NativeBridge.send('on_analytics_send', payload);
    output.value = JSON.stringify(payload);
  });

  btnAnalyticsEmpty?.addEventListener('click', () => {
    const payload = {
      name: "some_test_analytics_name_empty",
      params: {}
    };
    NativeBridge.send('on_analytics_send', payload);
    output.value = JSON.stringify(payload);
  });

  btnAnalyticsNil?.addEventListener('click', () => {
    const payload = {
      name: "some_test_analytics_name_null",
      params: null
    };
    NativeBridge.send('on_analytics_send', payload);
    output.value = JSON.stringify(payload);
  });

  btnRefresh?.addEventListener('click', () => {
    NativeBridge.send('on_token_expired', {});
    output.value = "Отправлено: on_token_expired";
  });

  // --- Обработка сообщений от native ---
  NativeBridge.on('nativeToWeb', (data) => {
    output.value = "Сообщение от native: " + JSON.stringify(data);
  });

  NativeBridge.on('on_token_updated', () => {
    const rsid = getCookie("rsid");
    cookieRsid.value = rsid || "(нет cookie)";
    output.value = "Получен on_token_updated — rsid обновлён из cookie";
  });

  NativeBridge.on('get_cookies', () => {
    cookieMcd.value = getCookie("is-mcd") || "(нет cookie)";
    cookieRsid.value = getCookie("rsid") || "(нет cookie)";
    NativeBridge.send('cookies_provided', { isMcd: cookieMcd.value, rsid: cookieRsid.value });
  });

  window.addEventListener('error', (e) => {
    console.error('window error', e);
    output.value = 'Ошибка в скрипте: ' + (e && e.message ? e.message : JSON.stringify(e));
  });
</script>


</body>
</html>
