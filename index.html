<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Native Bridge Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 20px;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 16px; /* расстояние между кнопками */
    }
    button:active {
      opacity: 0.7;
    }
    input {
      width: 90%;
      max-width: 400px;
      margin-top: 16px;
      font-size: 16px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h1>Bridge Test</h1>

  <div>
    <button id="sendBtn">Отправить команду в native</button>
  </div>
  <div>
    <button id="sendAnalyticsFull">Analytics full</button>
  </div>
  <div>
    <button id="sendAnalyticsEmpty">Analytics empty</button>
  </div>
  <div>
    <button id="sendAnalyticsNil">Analytics nil</button>
  </div>
  <div>
    <button id="refreshToken">Refresh token</button>
  </div>

  <input type="text" id="output" placeholder="Здесь появятся события от native" readonly />

  <input type="text" id="cookieMcd" placeholder="cookie is-mcd" readonly />
  <input type="text" id="cookieRsid" placeholder="cookie rsid" readonly />

  <script>
  // ---- Универсальный JS Bridge ----
  window.NativeBridge = (function () {
    const listeners = {};

    function sendToIOS(message) {
      try {
        if (window.webkit?.messageHandlers?.nativeBridge) {
          window.webkit.messageHandlers.nativeBridge.postMessage(message);
          return true;
        }
      } catch {}
      return false;
    }

    function sendToAndroid(message) {
      try {
        if (window.NativeBridgeAndroid?.postMessage) {
          window.NativeBridgeAndroid.postMessage(JSON.stringify(message));
          return true;
        }
        if (window.Android?.postMessage) {
          window.Android.postMessage(JSON.stringify(message));
          return true;
        }
      } catch {}
      return false;
    }

    function send(name, payload) {
      const msg = { name, payload };
      if (!sendToIOS(msg) && !sendToAndroid(msg)) {
        console.warn('No native bridge found for message:', msg);
      }
    }

    function receive(name, payload) {
      const list = listeners[name];
      if (list) list.forEach((cb) => cb(payload));
    }

    function on(name, callback) {
      listeners[name] = listeners[name] || [];
      listeners[name].push(callback);
    }

    window.__nativeReceive = function (name, payloadJSON) {
      let payload = payloadJSON;
      if (typeof payloadJSON === 'string') {
        try { payload = JSON.parse(payloadJSON); } catch {}
      }
      receive(name, payload);
    };

    return { send, on };
  })();
  // ---- Конец Bridge ----

  const output = document.getElementById('output');
  const cookieMcd = document.getElementById('cookieMcd');
  const cookieRsid = document.getElementById('cookieRsid');

  const output = document.getElementById('output');
    const cookieMcd = document.getElementById('cookieMcd');
    const cookieRsid = document.getElementById('cookieRsid');

    const button = document.getElementById('sendBtn');
    const buttonAnalyticsFull = document.getElementById('sendAnalyticsFull');
    const buttonAnalyticsEmpty = document.getElementById('sendAnalyticsEmpty');
    const buttonAnalyticsNil = document.getElementById('sendAnalyticsNil');
    const buttonRefresh = document.getElementById('refreshToken');


    button.addEventListener('click', () => {
      const payload = { event_type: "on_personal_account_pressed" };
      NativeBridge.send('on_personal_account_pressed', payload);
      output.value = "Отправлено в native: " + JSON.stringify(payload);
    });

    buttonAnalyticsFull.addEventListener('click', () => {
      const payload = {
        name: "some_test_analytics_name_full",
        params: {
          user_id: "1234",
          some_values: [
            { some_value: "1" },
            { some_value: "2" }
          ]
        }
      };
      NativeBridge.send('on_analytics_send', payload);
      output.value = JSON.stringify(payload);
    });

    buttonAnalyticsEmpty.addEventListener('click', () => {
      const payload = {
        name: "some_test_analytics_name_empty",
        params: {}
      };
      NativeBridge.send('on_analytics_send', payload);
      output.value = JSON.stringify(payload);
    });

    buttonAnalyticsNil.addEventListener('click', () => {
      const payload = {
        name: "some_test_analytics_name_null",
        params: null
      };
      NativeBridge.send('on_analytics_send', payload);
      output.value = JSON.stringify(payload);
    });

    buttonRefresh.addEventListener('click', () => {
      NativeBridge.send('on_token_expired', {});
      output.value = "Отправлено: on_token_expired";
    });

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return match ? decodeURIComponent(match[1]) : '';
  }

  cookieMcd.value = getCookie("is-mcd") || "(нет cookie)";
  cookieRsid.value = getCookie("rsid") || "(нет cookie)";

  NativeBridge.on('on_token_updated', () => {
     const rsid = getCookie("rsid");
     cookieRsid.value = rsid || "(нет cookie)";
     output.value = "Получен on_token_updated";
  });

</script>


</body>
</html>
